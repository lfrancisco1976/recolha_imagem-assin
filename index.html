<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formul√°rio Recolha</title>
<style>
body { margin:0; font-family:system-ui,sans-serif; background:#f4f6fb; padding:20px; display:flex; justify-content:center;}
.container { max-width:480px; width:100%; background:#fff; padding:20px; border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
h1 { color:#1a73e8; text-align:center; font-size:1.5rem; margin-bottom:18px; }
input, textarea, button { width:100%; padding:12px; margin:8px 0; border-radius:10px; border:1px solid #ccc; box-sizing:border-box; font-size:1rem;}
textarea { min-height:80px; resize:vertical;}
button { background:#1a73e8; color:white; border:none; cursor:pointer; font-size:1rem; }
button:disabled { background:#aaa; cursor:not-allowed;}
img.preview { width:100%; display:none; margin:12px 0; border-radius:10px;}
canvas { border:1px solid #ccc; border-radius:10px; width:100%; height:200px; touch-action: none; margin:12px 0; }
.loader { display:none; margin:12px auto; border:5px solid #eee; border-top:5px solid #1a73e8; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite;}
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
</style>
</head>
<body>
<div class="container">
<h1>üìã Formul√°rio Recolha</h1>

<label>Data</label>
<input type="date" id="data" required>

<label>Imagem</label>
<input type="file" id="foto" accept="image/*" capture="environment">
<img id="preview" class="preview">

<label>Assinatura</label>
<canvas id="assinaturaCanvas"></canvas>
<button id="limparAssinatura" style="background:#555;margin-bottom:12px;">üßπ Limpar assinatura</button>

<div class="loader" id="loader"></div>
<button id="guardar">üíæ Enviar</button>
</div>

<script>
// ------------------- IMAGEM -------------------
const foto = document.getElementById('foto');
const preview = document.getElementById('preview');
let base64Imagem = "";

foto.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onloadend = () => {
    base64Imagem = reader.result;
    preview.src = base64Imagem;
    preview.style.display = 'block';
  };
  reader.readAsDataURL(file);
});

// ------------------- ASSINATURA -------------------
const canvas = document.getElementById('assinaturaCanvas');
const ctx = canvas.getContext('2d');
let drawing = false;
let lastX = 0;
let lastY = 0;

canvas.width = canvas.offsetWidth;
canvas.height = canvas.offsetHeight;

function getPointerPos(e) {
  const rect = canvas.getBoundingClientRect();
  let x, y;
  if(e.touches) {
    x = e.touches[0].clientX - rect.left;
    y = e.touches[0].clientY - rect.top;
  } else {
    x = e.clientX - rect.left;
    y = e.clientY - rect.top;
  }
  return {x,y};
}

function startDraw(e){ drawing=true; const pos=getPointerPos(e); lastX=pos.x; lastY=pos.y; e.preventDefault(); }
function draw(e){ if(!drawing) return; const pos=getPointerPos(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(pos.x,pos.y); ctx.strokeStyle="#000"; ctx.lineWidth=2; ctx.stroke(); lastX=pos.x; lastY=pos.y; e.preventDefault();}
function endDraw(e){ drawing=false; }

canvas.addEventListener('mousedown', startDraw);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', endDraw);
canvas.addEventListener('mouseout', endDraw);
canvas.addEventListener('touchstart', startDraw);
canvas.addEventListener('touchmove', draw);
canvas.addEventListener('touchend', endDraw);

document.getElementById('limparAssinatura').addEventListener('click', ()=>{
  ctx.clearRect(0,0,canvas.width,canvas.height);
});

// ------------------- ENVIO -------------------
const loader = document.getElementById('loader');
const btn = document.getElementById('guardar');

btn.addEventListener('click', async ()=>{
  const dataForm = document.getElementById('data').value;
  if(!dataForm){ alert("Escolha uma data."); return; }
  if(!base64Imagem){ alert("Selecione ou tire uma imagem."); return; }
  const assinaturaBase64 = canvas.toDataURL("image/png");
  if(ctx.getImageData(0,0,canvas.width,canvas.height).data.every(v=>v===0)){ 
    alert("Assine no campo de assinatura."); return;
  }

  btn.disabled = true;
  loader.style.display = 'block';

  try{
    const payload = {
      data: dataForm,
      imagem: base64Imagem,
      assinatura: assinaturaBase64,
      nome: "Formul√°rio Recolha"
    };

    const response = await fetch("https://script.google.com/macros/s/AKfycbyf_L0tFKRpVUaFuZcsWQpj61mwLu53YoYXmWyFKQZjN38al9oLu5nMgLxTaJlFa9Xq/exec", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });

    const result = await response.json();
    if(result.status==="success"){
      alert("‚úÖ Formul√°rio enviado com sucesso!");
      document.getElementById('data').value="";
      foto.value="";
      preview.style.display='none';
      ctx.clearRect(0,0,canvas.width,canvas.height);
    } else {
      alert("‚ùå Erro: "+(result.message||"Erro no envio"));
    }

  } catch(err){
    alert("‚ùå Erro ao enviar: "+err.message);
  } finally{
    btn.disabled=false;
    loader.style.display='none';
  }
});
</script>
</body>
</html>
