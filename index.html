<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formul√°rio Recolha</title>
<style>
body { margin:0; font-family:system-ui,sans-serif; background:#f4f6fb; padding:20px; display:flex; justify-content:center;}
.container { max-width:480px; width:100%; background:#fff; padding:20px; border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
h1 { color:#1a73e8; text-align:center; font-size:1.5rem; margin-bottom:18px; }
input, textarea, button { width:100%; padding:12px; margin:8px 0; border-radius:10px; border:1px solid #ccc; box-sizing:border-box; font-size:1rem;}
textarea { min-height:80px; resize:vertical;}
button { background:#1a73e8; color:white; border:none; cursor:pointer; font-size:1rem; }
button:disabled { background:#aaa; cursor:not-allowed;}
img.preview { width:100%; display:none; margin:12px 0; border-radius:10px;}
.loader { display:none; margin:12px auto; border:5px solid #eee; border-top:5px solid #1a73e8; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite;}
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
</style>
</head>
<body>
<div class="container">
<h1>üìã Formul√°rio Recolha</h1>

<label>Data</label>
<input type="date" id="data" required>

<label>Imagem</label>
<input type="file" id="foto" accept="image/*" capture="environment">
<img id="preview" class="preview">

<label>Assinatura</label>
<iframe id="assinaturaFrame" src="https://lfrancisco1976.github.io/recolha_assinatura/" style="width:100%;height:200px;border:1px solid #ccc;border-radius:10px;"></iframe>

<div class="loader" id="loader"></div>
<button id="guardar">üíæ Enviar</button>
</div>

<script>
const foto = document.getElementById('foto');
const preview = document.getElementById('preview');
const loader = document.getElementById('loader');
const btn = document.getElementById('guardar');
let base64Imagem = "";

// Preview da imagem
foto.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onloadend = () => {
    base64Imagem = reader.result;
    preview.src = base64Imagem;
    preview.style.display = 'block';
  };
  reader.readAsDataURL(file);
});

// Fun√ß√£o para recolher assinatura via postMessage do iframe
let assinaturaData = "";
window.addEventListener("message", (event) => {
  // Apenas aceitar do teu dom√≠nio
  if (event.origin !== "https://lfrancisco1976.github.io") return;
  if (event.data && event.data.type === "assinatura") {
    assinaturaData = event.data.base64 || "";
    console.log("Assinatura recebida", assinaturaData);
  }
});

// Envio
btn.addEventListener('click', async () => {
  const dataForm = document.getElementById('data').value;
  if (!dataForm) { alert("Escolha uma data."); return; }
  if (!base64Imagem) { alert("Selecione ou tire uma imagem."); return; }
  if (!assinaturaData) { alert("Assine na √°rea de assinatura."); return; }

  btn.disabled = true;
  loader.style.display = 'block';

  try {
    const payload = {
      nome: "Formul√°rio", // podes adicionar campos adicionais
      obs: "Assinatura inclu√≠da",
      data: dataForm,
      imagem: base64Imagem,
      assinatura: assinaturaData
    };

    const response = await fetch("https://script.google.com/macros/s/AKfycbyf_L0tFKRpVUaFuZcsWQpj61mwLu53YoYXmWyFKQZjN38al9oLu5nMgLxTaJlFa9Xq/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    if(result.status === "success"){
      alert("‚úÖ Formul√°rio enviado com sucesso!");
      document.getElementById('data').value = '';
      foto.value = '';
      preview.style.display = 'none';
      assinaturaData = "";
      const iframe = document.getElementById('assinaturaFrame');
      iframe.contentWindow.postMessage({ type: "reset" }, "https://lfrancisco1976.github.io");
    } else {
      alert("‚ùå Erro: " + (result.message || "Erro no envio"));
    }

  } catch(err){
    alert("‚ùå Erro ao enviar: "+err.message);
  } finally {
    btn.disabled = false;
    loader.style.display = 'none';
  }
});
</script>
</body>
</html>
